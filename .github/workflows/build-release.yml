name: Build and Release EXE

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        type: string

permissions:
  contents: write
  actions: read

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest

    steps:
      # ============================================
      # Checkout repository
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection

      # ============================================
      # Setup Python
      # ============================================
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # ============================================
      # Setup Node.js
      # ============================================
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: station_ui/package-lock.json

      # ============================================
      # Extract version
      # ============================================
      - name: Extract version from pyproject.toml
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
            Write-Output "Using manual version: $version"
          } elseif ("${{ github.ref }}" -like "refs/tags/v*") {
            $version = "${{ github.ref }}".Replace("refs/tags/v", "")
            Write-Output "Using tag version: $version"
          } else {
            $content = Get-Content pyproject.toml
            $versionLine = $content | Select-String -Pattern '^version\s*=\s*"([^"]+)"'
            if ($versionLine) {
              $version = $versionLine.Matches.Groups[1].Value
              Write-Output "Extracted from pyproject.toml: $version"
            } else {
              $version = "1.0.0"
              Write-Output "Could not extract version, using default: $version"
            }
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "BUILD_NAME=StationService_v${version}_Windows_x64" >> $env:GITHUB_OUTPUT

      # ============================================
      # Install Python dependencies
      # ============================================
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .
          pip install pyinstaller

      # ============================================
      # Build React UI
      # ============================================
      - name: Install UI dependencies
        working-directory: ./station_ui
        run: npm ci

      - name: Build React UI
        working-directory: ./station_ui
        run: npm run build

      - name: Verify UI build
        shell: pwsh
        run: |
          if (!(Test-Path "station_service/static/index.html")) {
            Write-Error "UI build failed - index.html not found"
            exit 1
          }
          Write-Output "UI built successfully"

      # ============================================
      # Build EXE with PyInstaller
      # ============================================
      - name: Build EXE with PyInstaller
        run: pyinstaller station_service.spec --clean --noconfirm

      - name: Verify EXE build
        shell: pwsh
        run: |
          if (!(Test-Path "dist/StationService/StationService.exe")) {
            Write-Error "EXE build failed"
            exit 1
          }
          $size = (Get-Item "dist/StationService/StationService.exe").Length / 1MB
          Write-Output "EXE built successfully (${size:F2} MB)"

      # ============================================
      # Package deployment
      # ============================================
      - name: Create deployment package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $buildName = "${{ steps.version.outputs.BUILD_NAME }}"
          $outputDir = "dist/$buildName"

          Write-Output "Creating deployment package: $buildName"

          # Create directories
          New-Item -ItemType Directory -Path "$outputDir/sequences" -Force | Out-Null
          New-Item -ItemType Directory -Path "$outputDir/data" -Force | Out-Null
          New-Item -ItemType Directory -Path "$outputDir/logs" -Force | Out-Null
          New-Item -ItemType Directory -Path "$outputDir/config" -Force | Out-Null

          # Copy EXE and _internal
          Copy-Item -Path "dist/StationService/*" -Destination $outputDir -Recurse -Force

          # Copy sequences (external)
          Copy-Item -Path "sequences/*" -Destination "$outputDir/sequences" -Recurse -Force

          # Copy config template
          if (Test-Path "config/station.yaml.example") {
            Copy-Item "config/station.yaml.example" "$outputDir/config/station.yaml"
          } else {
            Copy-Item "config/station.yaml" "$outputDir/config/station.yaml"
          }

          # Create .gitkeep files
          New-Item -ItemType File -Path "$outputDir/data/.gitkeep" -Force | Out-Null
          New-Item -ItemType File -Path "$outputDir/logs/.gitkeep" -Force | Out-Null

          # Create VERSION.txt
          $version | Out-File -FilePath "$outputDir/VERSION.txt" -Encoding UTF8

          # Create README.txt
          @"
          F2X NeuroHub Station Service - Version $version
          ================================================

          Quick Start:
            1. Edit config\station.yaml with your station settings
            2. Run StationService.exe
            3. Access UI at http://localhost:8080/ui

          Directory Structure:
            StationService.exe     - Main executable
            _internal\             - Bundled dependencies (do not modify)
            config\                - Configuration files
            sequences\             - Test sequences (external, updatable)
            data\                  - Runtime data (SQLite DB)
            logs\                  - Application logs

          Configuration:
            Edit config\station.yaml to configure:
            - Station ID and name
            - Backend API URL
            - Server port (default: 8080)
            - Sequences directory path

          Support: https://github.com/Soochol/F2X_NeuroHub_Station
          "@ | Out-File -FilePath "$outputDir/README.txt" -Encoding UTF8

          Write-Output "Package created successfully"

      # ============================================
      # Generate checksums
      # ============================================
      - name: Generate SHA256 checksums
        shell: pwsh
        run: |
          $buildName = "${{ steps.version.outputs.BUILD_NAME }}"
          $exePath = "dist/$buildName/StationService.exe"

          $hash = (Get-FileHash -Path $exePath -Algorithm SHA256).Hash
          "$hash  StationService.exe" | Out-File -FilePath "$exePath.sha256" -Encoding ASCII

          Write-Output "SHA256: $hash"

      # ============================================
      # Create ZIP archive
      # ============================================
      - name: Create ZIP archive
        shell: pwsh
        run: |
          $buildName = "${{ steps.version.outputs.BUILD_NAME }}"

          Compress-Archive `
            -Path "dist/$buildName" `
            -DestinationPath "dist/$buildName.zip" `
            -CompressionLevel Optimal `
            -Force

          $size = (Get-Item "dist/$buildName.zip").Length / 1MB
          Write-Output "ZIP created: ${size:F2} MB"

      # ============================================
      # Upload artifacts
      # ============================================
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.BUILD_NAME }}
          path: dist/${{ steps.version.outputs.BUILD_NAME }}.zip
          retention-days: 30

      # ============================================
      # Create GitHub Release (only on tag push)
      # ============================================
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/${{ steps.version.outputs.BUILD_NAME }}.zip
            dist/${{ steps.version.outputs.BUILD_NAME }}/StationService.exe.sha256
          body: |
            ## F2X NeuroHub Station Service v${{ steps.version.outputs.VERSION }}

            ### Download
            - [Windows x64 ZIP](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ steps.version.outputs.BUILD_NAME }}.zip)

            ### Installation
            1. Download and extract the ZIP archive
            2. Edit `config/station.yaml` with your station settings
            3. Run `StationService.exe`
            4. Access the UI at http://localhost:8080/ui

            ### What's Included
            - Station Service FastAPI backend
            - React UI (embedded)
            - Test sequences (external, in `sequences/` folder)
            - Configuration template

            ### System Requirements
            - Windows 10/11 (64-bit)
            - No Python installation required
            - No additional dependencies required

            ### Checksum
            See `StationService.exe.sha256` for file integrity verification.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================
      # Summary
      # ============================================
      - name: Build summary
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $buildName = "${{ steps.version.outputs.BUILD_NAME }}"
          $exeSize = (Get-Item "dist/$buildName/StationService.exe").Length / 1MB
          $zipSize = (Get-Item "dist/$buildName.zip").Length / 1MB

          Write-Output "========================================="
          Write-Output "Build Completed Successfully!"
          Write-Output "========================================="
          Write-Output "Version:       $version"
          Write-Output "Build Name:    $buildName"
          Write-Output "EXE Size:      ${exeSize:F2} MB"
          Write-Output "ZIP Size:      ${zipSize:F2} MB"
          Write-Output "========================================="
